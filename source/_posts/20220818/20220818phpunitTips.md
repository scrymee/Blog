---
title: phpunitを使うときのTips一覧
categories:
  - programming
tags:
  - [phpunit]
date: 2022-08-18 16:00:41
---


<!-- toc -->

<!-- more -->

## phpunitを実行しやすくるために実装レベルで修正したいこと

Testの修正ではどうにもならないので実装レベルで直したいことについて

### 別の関数を呼び出すときはclassプロパティに値を挿入する

別のクラスの関数を呼び出すときに、下記のように関数内でインスタンスを宣言してから関数を呼び出すケースが有る。

```php

public function getUser()
{
  // ..中略
  $userClass = new User();
  $user = $userClass->find($id);
  // ..中略
}

```

これで動作上は問題ないのだが、テストの観点から見ると、この関数`getUser()`自体は別のクラスの関数を使用しているため依存度が高くなる。つまりテストを実行するときは、`User`クラスの`find`関数の動作まで保証して動作確認する必要がある。

もし、Userクラスのfind関数は別途テストケースを設けている場合は、テストが重複してしまう。
さらに、上記の例だと簡単でよいが、条件説が複雑に絡み合っており、戻り値がすぐに判断できないようなケースがあるとすると、実装時は問題なくても将来的に保守する側やテストケースを新たに追加する場合困る。

下記コードの説明。

```php
public function getUserPost($id, $name)
{
  // ..中略

  // -------------------
  // ユーザーインスタンスを呼び出す
  // -------------------
  $user = new User();

  // ------------------------------
  // ログインユーザーがItemを持っているときの関数での処理
  // ※ログインユーザー情報をもとに、created・name・adress・nicknameの情報が
  // なければ例外を返却してしまい処理が進まないことが400行程度のコードを読み解くとわかる
  // (本来そのようなデータが存在しないため考慮していなかった)
  // そのためここを通過させるためにユーザーをログインさせた状態をテストコードに追記する必要がある。。。ただ、ここはhaveItemList()関数のテストで記載すれば良い話なので、ここであえてその条件を追記するのは手間。
  // -------------------------------
  if ($user->haveItemList()) {
    // 中略
  } else {
    // ..中略
  }
}
```

こういうケースではUserの情報に必要な情報を調査する必要がある。最終的にコメントアウトにあるように必要な情報がわかったが、それらはこの関数のテスト自体になんの影響もないため、実際のところは、`haveItemList`の戻り値がtrueかfalseを設定できればよいだけなのに、関係ない箇所の調査に時間を要した。またこの関数自体では必要のないログインユーザーの情報を設定する必要もあった。テストケースも重複して記載することになりスマートではない。

これらの問題は、次で説明する`mock`や`stub`を使用することで依存関係の分離を実現できるのだが、上記の悪例のコードではmockなどを使用できない。

そのためできる限り外部の関数を呼び出すときはプロパティに持たせる。これはphpunitの機能でprivateプロパティの値をoverwriteする機能があるため、これを用いることができるようになる。
上記のままであると、上書きができない。

```php

private $_user;

public function __construct() {
  $this->_user = new User();
}

public function getUser()
{
  if ($user->haveItemList()) {
    // 中略
  } else {
    // ..中略
  }
}

```

この場合は、$_userのプロパティをmockやstubに置き換えてあげることで__constructなどを実行せずに、プロパティを指定できることから、haveItemListの依存関係から抜けられる

## mockの使い方

1. mockを作成する
2. 実行回数、引数それぞれの期待値を入力する
3. 外部関数のmockに組み込む

これで、外部関数の依存関係をなくした上でmockを作成できる
期待値ごとにテストを書いてあげると良い